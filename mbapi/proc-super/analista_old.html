<meta charset="utf8" />
<html>
  <script src='dist/sql-wasm.js'></script>
  <style>
    table {
      border-collapse: collapse;
      border-spacing: 0;
      width: 100%;
      border: 1px solid #ddd;
    }
    
    th {
      text-align: left;
      padding: 16px;
    }

    td {
      text-align: right;
      padding: 16px;
    }
    
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    #error {
        color: red;
    }

    tr:nth-child(10), /* ACTIVOS CORRIENTES */
    tr:nth-child(16), /* ACTIVOS NO CORRIENTES */
    tr:nth-child(24), /* PASIVOS CORRIENTES */
    tr:nth-child(32), /* PASIVOS NO CORRIENTES */
    tr:nth-child(40), /* PATRIMONIO */
    tr:nth-child(49), /* PYG */
    tr:nth-child(63),  /* INDICADOREs */
    tr:nth-child(90)  /* CUPO */
    {
        background-color: #6AB187;
    }

    tr:nth-child(15), /* TOTAL ACTIVOS CORRIENTES */
    tr:nth-child(22), /* TOTAL ACTIVOS NO CORRIENTES */
    tr:nth-child(31), /* TOTAL PASIVOS CORRIENTES */
    tr:nth-child(38), /* TOTAL PASIVOS NO CORRIENTES */
    tr:nth-child(48), /* TOTAL PASIVO + PATRIMONIO */
    tr:nth-child(62), /* RESULTADO DEL EJERCICIO */
    tr:nth-child(88)  /* CUPO APROBADO */
    {
        background-color: #DBAE58;
    }
    tr:nth-child(23), /* TOTAL ACTIVOS */
    tr:nth-child(39), /* TOTAL PASIVOS */
    tr:nth-child(47), /* TOTAL PATRIMONIO */
    tr:nth-child(52), /* RESULTADO BRUTO */
    tr:nth-child(55), /* RESULTADO OPERACIONAL */
    tr:nth-child(60), /* RESULTADO ANTES DE IMPUESTOS */
    tr:nth-child(87),  /* PUNTAJE */
    tr:nth-child(89)  /* PUNTAJE SEGUN SECTOR */
    {
        color: #FFFFFF;
        background-color: #1F3F49;
    }
    </style></style>
  <body>
    <label for="nit"></label>
    <main>
        <div class="" style="display:block"><img src="logo.png" style="width:25%"></div>
        <div>
            <th>Abrir Base de Datos:</th>
            <td><input type="file" id="dbfile"></td>
        </div>
        <div>
            <th>Ingrese Nit:</th>
            <td><input type="text" id="nit"></td>
            <td><button id="buscar" class="button">Buscar</button></td>  
            <td><button id="transpose" class="button" style="display:none">Transponer</button></td>  
        
        </div>
        <div style="display:none">
            <td>SQL:</td>
            <td><textarea id="commands" rows="10" cols="40"></textarea></td>
            <td><button id="execute" class="button">Ejecutar</button></td>                
        </div>
    

        <!-- <button id="savedb" class="button">Save the db</button> -->
    
        <div id="error" class="error"></div>
    
        <table id="output"></table>
      </main>
      <script>
        var inputElement = document.getElementById("dbfile");
        var buscarBtn = document.getElementById("buscar");
        var transposeBtn = document.getElementById("transpose");
        var executeBtn = document.getElementById("execute");
        var output  = document.getElementById("output");
        var errorDiv  = document.getElementById("error");
        var editor  = document.getElementById("commands");

        // Start the worker in which sql.js will run
        var worker = new Worker("dist/worker.sql-wasm.js");
        worker.onerror = error;
        
        // Open a database
        worker.postMessage({ action: 'open' });
        execute        
        
        // Run a command in the database
        function execute(commands) {
            noerror();
            tic();
            worker.onmessage = function (event) {
                var results = event.data.results;
                toc("Executing SQL");
                if (!results) {
                    error({message: event.data.error});
                    return;
                }
        
                tic();
                output.innerHTML = "";
                for (var i = 0; i < results.length; i++) {
                    output.appendChild(tableCreate(results[i].columns, results[i].values));
                }
                toc("Displaying results");
            }
            worker.postMessage({ action: 'exec', sql: commands });
            output.textContent = "Fetching results...";
        }
        
        // Create an HTML table
        var tableCreate = function () {
            function valconcat(vals, tagName) {
                if (vals.length === 0) return '';
                var open = '<' + tagName + '>', close = '</' + tagName + '>';
                return open + vals.join(close + open) + close;
            }
            return function (columns, values) {

                for (var jj = 0; jj < values.length; jj++) {
                    for (var mm = 0; mm < values[jj].length; mm++) {
                        if(values[jj][mm] !== '' && !isNaN(values[jj][mm])){
                            values[jj][mm] = Number(values[jj][mm]).toLocaleString() + 
                            ( columns[mm].indexOf('(%)') > -1 ? '%' : '' );
                        }
                        //console.log(mm, values[jj][mm])
                    }
                }

                var tbl = document.createElement('table');
                var html = '<thead>' + valconcat(columns, 'th') + '</thead>';
                var rows = values.map(function (v) { return valconcat(v, 'td'); });
                html += '<tbody>' + valconcat(rows, 'tr') + '</tbody>';
                tbl.innerHTML = html;
                return tbl;
            }
        }();

        function error(e) {
            console.log(e);
            errorDiv.style.height = '2em';
            errorDiv.textContent = e.message;
            output.textContent = '';
        }

        // Execute the commands when the button is clicked
        function execEditorContents() {
            noerror()
            execute(editor.value);
        }
/*
        "v21" : ["Capital emitido"],
        "v22" : ["Prima de emisión"],
        "v23" : ["Otras reservas"],
        "v24" : ["Ganancias acumuladas"],
        "v25" : ["Resultado del Ejercicio"],
        "v26" : ["CALCULADA"],
        "tot_PATRIMONIO" : ["Patrimonio total"],
        "tot_PASIVO_PATRIMONIO" : ["Total de patrimonio y pasivos"]
*/
        // Execute the commands when the button is clicked
        function execBuscarNit() {
            noerror()
            execute(`
SELECT 
   caratula.nit as 'NIT:', 
   caratula.razon as 'EMPRESA:', 
   caratula.ciiu as 'CÓDIGO CIIU:', 
   ciiu.descripcion as 'SECTOR:', 
   caratula.pyme as 'PYME:', 
   caratula.ind as 'ENTRADA:',
   ESF.periodo as 'PERÍODO:', 
   ESF.fecha as 'FECHA:', 
   ESF.unidades as 'UNIDADES:', 
   '' as 'ACTIVOS CORRIENTES', 
   ESF.v1 as '1.- Efectivo y equivalentes al efectivo:', 
   ESF.v2 as '2.- Otros Activos Corrientes:', 
   ESF.v3 as '3.- Cuentas por cobrar comerciales y otras (neto):', 
   ESF.v4 as '4.- Inventarios (neto):', 
   ESF.tot_AC_CO as 'TOTAL ACTIVOS CORRIENTES', 
   '' as 'ACTIVOS NO CORRIENTES', 
   ESF.v5 as '5.- Propiedad, planta y equipo (neto):', 
   ESF.v6 as '6.- Cuentas por cobrar comerciales y otras (neto):',
   ESF.v7 as '7.- Propiedades de Inversión:', 
   ESF.v8 as '8.- Otros Activos:', 
   ESF.v9 as '9.- Activos por impuestos diferidos:', 
   ESF.tot_AC_NCO as 'TOTAL ACTIVOS NO CORRIENTES', 
   ESF.tot_ACTIVOS as 'TOTAL ACTIVOS', 
   '' as 'PASIVOS CORRIENTES', 
   ESF.v10 as '10.- Obligaciones financieras:', 
   ESF.v11 as '11.- Cuentas por pagar comerciales:', 
   ESF.v12 as '12.- Otros pasivos corrientes:', 
   ESF.v13 as '13.- Beneficios a empleados:', 
   ESF.v14 as '14.- Impuestos por pagar:', 
   ESF.v15 as '15.- Otros pasivos no financieros:', 
   ESF.tot_PS_CO as 'TOTAL PASIVOS CORRIENTES', 
   '' as 'PASIVOS NO CORRIENTES', 
   ESF.v16 as '16.- Obligaciones financieras:', 
   ESF.v17 as '17.- Comerciales y otras cuentas por pagar:', 
   ESF.v18 as '18.- Pasivo por impuestos diferidos:', 
   ESF.v19 as '19.- Impuestos por pagar:', 
   ESF.v20 as '20.- Otros pasivos no corrientes:', 
   ESF.tot_PS_NCO as 'TOTAL PASIVOS NO CORRIENTES', 
   ESF.tot_PASIVOS as 'TOTAL PASIVOS', 
   '' as 'PATRIMONIO', 
   ESF.v21 as '21.- Capital pagado:', 
   ESF.v22 as '22.- Prima en colocación de acciones:', 
   ESF.v23 as '23.- Reservas:', 
   ESF.v24 as '24.- Resultados acumulados:', 
   ESF.v25 as '25.- Resultado del ejercicio:', 
   ESF.v26 as '26.- Otro resultado integral:', 
   ESF.tot_PATRIMONIO as 'TOTAL PATRIMONIO', 
   ESF.tot_PASIVO_PATRIMONIO as 'TOTAL PASIVO + PATRIMONIO', 
   '' as 'PRINCIPALES CUENTAS DE PÉRDIDAS Y GANANCIAS', 
   ERI.v27 as '27.- Ingreso de actividades ordinarias:', 
   ERI.v28 as '28.- Costo de ventas:', 
   ERI.tot_RES_BRUTO as 'RESULTADO BRUTO:', 
   ERI.v29 as '29.- Gastos de administración:', 
   ERI.v30 as '30.- Gastos de ventas:', 
   ERI.tot_RES_OPERACIONAL as 'RESULTADO OPERACIONAL:', 
   ERI.v31 as '31.- Gastos financieros:', 
   ERI.v32 as '32.- Otros gastos:', 
   ERI.v33 as '33.- Ingresos financieros:', 
   ERI.v34 as '34.- Otros ingresos:', 
   ERI.tot_RES_ANTES_IMP as 'RESULTADO ANTES DE IMPUESTOS:', 
   ERI.v35 as '35.- Gasto (ingreso) por impuestos (neto):', 
   ERI.tot_RES_OPERACIONAL as 'RESULTADO DEL EJERCICIO:', 
   '' as 'INDICADORES FINANCIEROS', 
   indfin.solvencia as 'Solvencia',
   indfin.razon_cte || ' Pts: <b>' || (puntos.pts_razon_cte * 100) || '</b>' as 'Razón Corriente',
   indfin.prueba_acida as 'Prueba ácida',
   indfin.capital_trabajo as 'Capital de Trabajo',
   indfin.ROE as 'ROE',
   indfin.fin_ventas as 'Gastos financieros / ventas  (%)',
   indfin.gearing as 'Gearing  (%)',
   indfin.ap_act_ing as 'Apalancamiento Activos Fijos / Ingresos  (%)',
   indfin.ap_act_tot as 'Apalancamiento activos fijos / Activo Total  (%)',
   indfin.end_fin as 'Endeudamiento Financiero (%)',
   indfin.end_ventas as 'Endeudamiento a ventas (%)',
   indfin.end_total || ' Pts: <b>' || (puntos.pts_end_total * 100) || '</b>' as 'Endeudamiento total (%)',
   indfin.conc_CP as 'Concentración en corto plazo (%)',
   indfin.deuda_CP_ventas as 'Relación deuda corto plazo / Ventas (%)',
   indfin.gas_fin_uti_op as 'Gastos financieros / Utilidad Operacional (%)',
   indfin.ap_bancario as 'Apalancamiento bancario (%)',
   indfin.margen_op as 'Margen operacional',
   indfin.margen_neto as 'Margen neto',
   indfin.rot_inv as 'Rotación inventario',
   indfin.rot_cart as 'Rotación de cartera',
   indfin.ciclo_op || ' Pts: ' || (puntos.pts_ciclo_op * 100) as 'Ciclo operacional',
   indfin.pago_prov as 'Periodo pago proveedores',
   indfin.renta_op || ' Pts: <b>' || (puntos.pts_renta_op * 100) || '</b>' as 'Rentabilidad operacional (%)',
   scoring.scoring * 100 as 'PUNTAJE:',
   ciiu.riesgo as 'PUNTAJE SECTOR:', 
   scoring.scoring * ciiu.riesgo / 10 as 'PUNTAJE (Según SECTOR):', 
   scoring.cupo as 'CUPO APROBADO:'
FROM
    caratula, 
    ciiu,
    ESF, ERI, indfin,
	scoring,
    puntos
WHERE caratula.nit = '${nit.value}' AND
      ciiu.codigo = caratula.ciiu AND
      ESF.nit = caratula.nit AND ESF.periodo = scoring.periodo AND
      ERI.nit = caratula.nit AND ERI.periodo = scoring.periodo AND
      indfin.nit = caratula.nit AND indfin.periodo = scoring.periodo AND
	  scoring.nit = caratula.nit AND
      puntos.nit = caratula.nit AND puntos.periodo = scoring.periodo
ORDER BY ESF.periodo desc
`);
        }

        // Execute the commands when the button is clicked
        function execTranspose() {
            transposeTable(document.querySelector("table table"));
        }

        function noerror() {
            errorDiv.style.height = '0';
            errorDiv.textContent = '';
        }

        // Performance measurement functions
        var tictime;
        if (!window.performance || !performance.now) { window.performance = { now: Date.now } }
        function tic() { tictime = performance.now() }
        function toc(msg) {
            var dt = performance.now() - tictime;
            console.log((msg || 'toc') + ": " + dt + "ms");
        }
        
        // Load a db from a file
        function handleFiles() {
            var f = document.getElementById('dbfile').files[0];
            var r = new FileReader();
            r.onload = function () {
                worker.onmessage = function () {
                    toc("Loading database from file");
                    // Show the schema of the loaded database
                    execute("SELECT `name`, `sql`\n  FROM `sqlite_master`\n  WHERE type='table';");
                };
                tic();
                try {
                    worker.postMessage({ action: 'open', buffer: r.result }, [r.result]);
                }
                catch (exception) {
                    worker.postMessage({ action: 'open', buffer: r.result });
                }
            }
            r.readAsArrayBuffer(f);
        }
        
        // Save the db to a file
        function savedb() {
            worker.onmessage = function (event) {
                toc("Exporting the database");
                var arraybuff = event.data.buffer;
                var blob = new Blob([arraybuff]);
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.href = window.URL.createObjectURL(blob);
                a.download = "sql.db";
                a.onclick = function () {
                    setTimeout(function () {
                        window.URL.revokeObjectURL(a.href);
                    }, 1500);
                };
                a.click();
            };
            tic();
            worker.postMessage({ action: 'export' });
        }
        
        const transposeTable = (tbody, newContainerType = "tbody") => {
            const rows = Array.from(tbody.querySelectorAll("tr"))
            const newTbody = document.createElement(newContainerType)

            for (let rowIdx = 0; rowIdx < rows.length; rowIdx++) {
                const row = rows[rowIdx]
                const cells = Array.from(row.querySelectorAll("td, th"))

                for (let cellIdx = 0; cellIdx < cells.length; cellIdx++ ) {
                const cell = cells[cellIdx]
                const newRow = newTbody.children[cellIdx] || document.createElement("tr")
                if (!newTbody.children[cellIdx]) {
                    newTbody.appendChild(newRow)
                }
                newRow.appendChild(cell.cloneNode(true))
                }
            }
            
            // Do live DOM manipulations only once for performance
            tbody.parentElement.appendChild(newTbody)
            tbody.parentElement.removeChild(tbody)
        }

        // Events
        inputElement.addEventListener("change", handleFiles, false);
        executeBtn.addEventListener("click", execEditorContents, true);
        buscarBtn.addEventListener("click", execBuscarNit, true);
        transposeBtn.addEventListener("click", execTranspose, true);

      </script>
  </body>
</html>